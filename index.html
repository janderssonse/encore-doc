<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="SVT Videocore">
<title>SVT Encore Documentation</title>
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */

@import url("//fonts.googleapis.com/css?family=Noto+Sans:300,600italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700");
@import url(https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css); /* Default asciidoc style framework - important */

/* CUSTOMISATIONS */
/* Change the values in root for quick customisation. If you want even more fine grain... venture further. */

:root {
    --maincolor: #FFFFFF;
    --primarycolor: #2c3e50;
    --secondarycolor: #ba3925;
    --tertiarycolor: #186d7a;
    --sidebarbackground: #CCC;
    --linkcolor: #b71c1c;
    --linkcoloralternate: #f44336;
    --white: #FFFFFF;
    --black: #000000;
}

/* Text styles */
h1 {
    color: var(--primarycolor) !important;
}

h2, h3, h4, h5, h6 {
    color: var(--secondarycolor) !important;
}

.title {
    color: var(--tertiarycolor) !important;
    font-family: "Noto Sans", sans-serif !important;
    font-style: normal !important;
    font-weight: normal !important;
}

p {
    font-family: "Noto Sans", sans-serif !important
}

/* Table styles */
th {
    font-family: "Noto Sans", sans-serif !important
}

/* Responsiveness fixes */
video {
    max-width: 100%;
}

@media all and (max-width: 600px) {
    table {
        width: 55vw !important;
        font-size: 3vw;
    }
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>SVT Encore Documentation</h1>
<div class="details">
<span id="author" class="author">SVT Videocore</span><br>
<span id="email" class="email"><a href="mailto:videocore@svt.se">videocore@svt.se</a></span><br>
<span id="revnumber">version 0.1,</span>
<span id="revdate">2021-10-08</span>
<br><span id="revremark">Alpha Edition</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#license">License</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#the-user-guide">The User Guide</a>
<ul class="sectlevel2">
<li><a href="#installation">Installation</a></li>
</ul>
</li>
<li><a href="#the-concepttechnical-guide">The Concept/Technical Guide</a>
<ul class="sectlevel2">
<li><a href="#concepts">Concepts</a></li>
<li><a href="#workflow">Workflow</a></li>
<li><a href="#apiendpoints">API/Endpoints</a></li>
<li><a href="#models">Models</a></li>
</ul>
</li>
<li><a href="#the-community-guide">The Community Guide</a>
<ul class="sectlevel2">
<li><a href="#faq">Frequently Asked Questions</a></li>
<li><a href="#articles-and-talks">Articles and talks</a></li>
<li><a href="#support">Support</a></li>
<li><a href="#projecthistory">Project History</a></li>
</ul>
</li>
<li><a href="#contributorguide">The Contributor Guide</a>
<ul class="sectlevel2">
<li><a href="#changing-the-code-base">Changing the code-base</a></li>
<li><a href="#sign-off-and-optionally-sign-each-commit">Sign-off and optionally Sign each Commit</a></li>
<li><a href="#git-history">Git History</a></li>
</ul>
</li>
<li><a href="#appendix">Appendix</a>
<ul class="sectlevel2">
<li><a href="#application-properties">Application Properties</a></li>
<li><a href="#homebrew-avtools">Homebrew AVTools</a></li>
<li><a href="#profiles">Profiles</a></li>
<li><a href="#the-future">The Future</a></li>
<li><a href="#asciidoc-debug">Asciidoc Debug</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="license">License</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>This work is licensed under the Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0) License. To view a copy of this license, visit <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="bare">https://creativecommons.org/licenses/by-sa/4.0/</a> or send a letter to Creative Commons, PO Box 1866, Mountain View, CA 94042, USA.</em></p>
</div>
<div class="paragraph">
<p>Copyright 2021 Sveriges Television AB</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This documentation is in a work-in-progress state. Not all features are yet described.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>This is a living, breathing guide</strong>. If youâ€™d like to contribute,  <a href="https://github.com/svt/encore-doc">fork us on GitHub!</a></p>
</div>
<div class="paragraph">
<p><strong><em>What is Encore?</em></strong></p>
</div>
<div class="paragraph">
<p><strong>Encore</strong> is a scalable video transcoding<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> tool, built on Open Source giants like <a href="https://www.ffmpeg.org/">FFmpeg</a> and <a href="https://github.com/redisson">Redisson</a>.</p>
</div>
<div class="paragraph">
<p><strong><em>Why does it exist?</em></strong></p>
</div>
<div class="paragraph">
<p><strong>Encore</strong> was created to scale, and abstract the transcoding <em>power of FFmpeg</em>, and to offer a simple solution for Transcoding - Transcoding-as-a-Service.</p>
</div>
<div class="paragraph">
<p>See the <a href="#projecthistory">Project History</a> for more about that.</p>
</div>
<div class="paragraph">
<p><strong><em>Who is it for?</em></strong></p>
</div>
<div class="paragraph">
<p><strong>Encore</strong> is aimed at the advanced technical user that needs a scalable video transcoding tool - for example, as a part of their VOD (Video On Demand) transcoding pipeline.</p>
</div>
<div class="paragraph">
<p><strong><em>How can you use it?</em></strong></p>
</div>
<div class="paragraph">
<p>For example, you could deploy a number of <strong>Encore</strong> instances within your existing Kubernetes/Docker/other container solution and let the running instances communicate with a Redis cluster (as a Queue message broker). Every instance can than pick the next job lot, and you can scale your transcoding as needed.</p>
</div>
<div class="paragraph">
<p><strong><em>Features</em></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Scalable - queuing and concurrency options</p>
</li>
<li>
<p>Flexible profile configuration</p>
</li>
<li>
<p>Possibility to extend FFmpeg functionality</p>
</li>
<li>
<p>Tested and tried in production</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><em>Encore is not</em></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>A live/stream transcoder</p>
</li>
<li>
<p>A Video packager (see <a href="#faq">Frequently Asked Questions</a>)</p>
</li>
<li>
<p>A GUI application</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><em>Built with</em></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kotlin</p>
</li>
<li>
<p>Gradle</p>
</li>
<li>
<p>Spring Boot</p>
</li>
<li>
<p>FFmpeg</p>
</li>
<li>
<p>Redisson</p>
</li>
<li>
<p>and many other great projects</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
API, Profiles, and other formats will change now and then before we reach version 1.0.0 - <strong>Encore</strong> is currently considered a work-in-progress tool.
It <strong>is</strong> used in daily production though.
</td>
</tr>
</table>
</div>
<div class="paragraph text-center">
<p><em>Encore - built on Open Source Giants</em></p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="img/svt_encore_at_a_glance.png" alt="svt encore at a glance" width="90%">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-user-guide">The User Guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This part of the documentation describes how to get going with a quick start and installation hints.</p>
</div>
<div class="sect2">
<h3 id="installation">Installation</h3>
<div class="paragraph">
<p>Currently, there are no <strong>pre-ready-to-go</strong> installation packages, pods, docker images offered for <strong>Encore</strong>, but fear not - there are a few possibilities in how to get going. Continue reading!</p>
</div>
<div class="sect3">
<h4 id="quickstart">Quickstart</h4>
<div id="requirements-run-local-boot" class="ulist">
<ul>
<li>
<p>Encore requires:</p>
<div class="ulist">
<ul>
<li>
<p>JDK 11 or later</p>
</li>
<li>
<p>An available Redis instance (default configuration: locally installed port 6379)</p>
</li>
<li>
<p>FFmpeg (we recommend the version present in <a href="https://github.com/svt/homebrew-avtools">Homebrew-AVTools</a> repository, which is what we use in our production environment)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="build-the-project">Build the project</h5>
<div class="paragraph">
<p>Run all tests and static analysis using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">  $ ./gradlew clean check</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="option-quick-test-trial-run-a-local-version-with-spring-boot-bootrun">Option - Quick Test Trial: Run a local version with Spring Boot bootRun</h5>
<div class="paragraph">
<p>You can run <strong>Encore</strong> on your local developer machine for a quick test trial by starting up a local developer Application Profile:</p>
</div>
<div class="listingblock">
<div class="title">In the <strong>Encore</strong> root folder:</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">  foobar@foo:~$ SPRING_PROFILES_ACTIVE=local ./gradlew clean bootRun</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This will use the <em>src/main/resources/application-local.yml</em> configuration profile in <strong>Encore</strong>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the startup fails, verify that you are fulfilling the <a href="#requirements-run-local-boot">requirements</a></p>
</div>
<div class="paragraph">
<p>Otherwise, verify that you can see the OpenAPI3 Swagger Gui in your browser, see <a href="#dynamicapiendpoints">Dynamically generated Endpoint documentation</a>.</p>
</div>
<div class="paragraph">
<p>Success?? Great - you might want to check out the <a href="#concepts">Concepts</a> next.</p>
</div>
</div>
<div class="sect4">
<h5 id="option-docker-image-run-encore-in-a-docker-image">Option - Docker Image: Run Encore in a Docker Image</h5>
<div class="paragraph">
<p>This quickstart option will show you how to use <a href="https://docs.brew.sh/Homebrew-on-Linux">Homebrew</a> and create an FFmpeg Docker Image to run Encore from.</p>
</div>
<div class="paragraph">
<p>First, you need to create a base FFmpeg Docker image.
The following skeleton example installs a recent version of FFmpeg, with a few FFmpeg filters, and mediainfo.
Modify as needed.</p>
</div>
<details>
<summary class="title">An FFmpeg Dockerfile example (click to expand)</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="dockerfile" class="language-dockerfile hljs">  FROM ubuntu:20.04

  ENV LC_ALL C.UTF-8
  ENV LANG C.UTF-8
  ENV TZ Europe/Stockholm
  RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone

  ARG USR="user"

  RUN apt-get update &amp;&amp; apt-get -y --no-install-recommends install \
  build-essential \
  curl \
  sudo \
  file \
  locales \
  ruby \
  git \
  expect \
  openssh-client  \
  ca-certificates \
  openjdk-11-jre-headless \
  zip \
  unzip

  RUN localedef -i en_US -f UTF-8 en_US.UTF-8 &amp;&amp; \
  useradd -ms /bin/bash ${USR} &amp;&amp; \
  echo '${USR}  ALL=(ALL) NOPASSWD:ALL' &gt;&gt;/etc/sudoers &amp;&amp; \
  echo 'Set disable_coredump false' &gt;&gt; /etc/sudo.conf

  RUN mkdir -m777 /ffmpeg-filters

  RUN bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"

  ENV PATH=/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:$PATH
  ENV JAVA_HOME /usr/lib/jvm/java-11-openjdk-amd64/

  RUN brew tap svt/avtools &amp;&amp; \
      brew install openssl@1.1 &amp;&amp; \
      brew unlink openssl@1.1 &amp;&amp; \
      brew install openssl@3 &amp;&amp; \
      brew install ffmpeg-encore libsvg-proxy-filter libsrf-proxy-filter mediainfo &amp;&amp; \
      sudo rm -rf "$(brew --cache)"

  RUN cp $(brew --prefix)/lib/libsvg_filter.so $(brew --prefix)/lib/libsrf_filter.so /ffmpeg-filters/

  USER ${USR}


  CMD ["ffmpeg", "-version"]</code></pre>
</div>
</div>
</div>
</details>
<div class="listingblock">
<div class="title">With env variable DOCKER_BASE_IMAGE pointing to your FFmpeg Docker Image</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">  foobar@foo:~$ docker build -t encore-docker --build-arg DOCKER_BASE_IMAGE=&lt;yourdockerbaseimage:youjustbuiltfromexample&gt; .

  foobar@foo:~$ docker run --network=host -e SPRING_PROFILES_ACTIVE='local' encore-docker</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that you can see the OpenAPI3 Swagger Gui in your browser, see <a href="#dynamicapiendpoints">Dynamically generated Endpoint documentation</a>.</p>
</div>
<div class="paragraph">
<p>Success?? Great - you might want to check out the <a href="#concepts">Concepts</a> next.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-concepttechnical-guide">The Concept/Technical Guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are looking for concepts, structures and API descriptions, this part of the documentation is for you.</p>
</div>
<div class="sect2">
<h3 id="concepts">Concepts</h3>

</div>
<div class="sect2">
<h3 id="workflow">Workflow</h3>
<div class="paragraph text-center">
<p><em>The workflow for an Encore Job</em></p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="img/svt_encore_workflow.png" alt="svt encore workflow" width="90%">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An Encore Job is created</p>
</li>
<li>
<p>It is offered to a Queue<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>. At some point, the Encore Job is picked up from the Queue</p>
</li>
<li>
<p>Metadata needed for the coming transcoding task is gathered - for example, the input file is analyzed, the Profile is read.</p>
</li>
<li>
<p>The transcoding is started - (FFmpeg transcoding starts)</p>
</li>
<li>
<p>Output files are written to the configured destination</p>
</li>
</ol>
</div>
<details>
<summary class="title">The Encore Job status field will roughly tell the observer where in the workflow it is currently (click to expand)</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="kotlin" class="language-kotlin hljs">  // SPDX-FileCopyrightText: 2020 Sveriges Television AB
  //
  // SPDX-License-Identifier: EUPL-1.2

  package se.svt.oss.encore.model

  enum class Status(val isCompleted: Boolean) {
      NEW(false),
      QUEUED(false),
      IN_PROGRESS(false),
      SUCCESSFUL(true),
      FAILED(true),
      CANCELLED(true);

      val isCancelled: Boolean
          get() = this == CANCELLED
  }</code></pre>
</div>
</div>
</div>
</details>
<div class="sect3">
<h4 id="encore-job">Encore Job</h4>
<div class="paragraph">
<p><em>An <strong>Encore</strong> Job is the aggregate for the information needed to transcode an input file - information like input files, <strong>profile</strong> and priority.</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <strong>Encore</strong> Job describes how an input file should be processed.</p>
</li>
<li>
<p>An <strong>Encore</strong> Job can have several output files, and one input file.</p>
</li>
<li>
<p>An <strong>Encore</strong> Job has a <strong><em>profile</em></strong>, which essentially describes how the job should configure it&#8217;s transcoding.</p>
</li>
<li>
<p>An <strong>Encore</strong> Job has a priority, which essentially describes how the job should be prioritized.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="profile">Profile</h4>
<div class="paragraph">
<p><em>A <strong>Profile</strong> can be seen as a general abstraction of an FFmpeg configuration - example, bitrate to use, thumbnail generation, the codec to use.</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <strong>Profile</strong> specifies a big part of the configuration used by an <strong>Encore</strong> Job - metadata, FFmpeg configuration and specific codec configuration.</p>
</li>
<li>
<p>A <strong>Profile</strong> is specified in the yaml-format.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="scaling-distribution-and-queues">Scaling, distribution and queues</h4>
<div class="paragraph">
<p><em>By using Redis (as a message broker/queue handler) and an internal concurrency scheduler, <strong>Encore</strong> can be scaled by setting up more instances, and allowing more concurrency.</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <strong>Encore</strong> instance uses Redis through Redisson&#8217;s  <a href="https://javadoc.io/doc/org.redisson/redisson/3.7.5/org/redisson/RedissonPriorityBlockingQueue.html"><em>Priority Blocking Queue</em></a>. Jobs are scheduled on an <strong>Encore</strong> instance according to a given priority.</p>
</li>
<li>
<p>Furthermore, The <strong>Encore</strong> concurrency setting affects how many transcoding jobs be run on the same instance at once.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>So, From an <strong>Encore</strong> instance&#8217;s point of view, the next Encore Job is chosen for transcoding according to its priority and according to how many concurrent tasks that are allowed on that instance.</em></p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="img/svt_encore_queue.png" alt="svt encore queue" width="90%">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="apiendpoints">API/Endpoints</h3>
<div class="paragraph">
<p><strong>Encore</strong> is built using the framework Spring Rest Data  <a href="https://docs.spring.io/spring-data/rest/docs/current/reference/html/#repository-resources.fundamentals">offering the default endpoints</a> generated from the usage of this framework.
However, other custom Endpoints exist.</p>
</div>
<div class="paragraph">
<p><strong>Encore&#8217;s</strong> endpoints are described and self-documented in the <a href="https://www.openapis.org/">OpenAPIv3 format</a>.</p>
</div>
<div class="sect3">
<h4 id="dynamicapiendpoints">Dynamically generated Endpoint documentation</h4>
<div class="paragraph">
<p>To see and interact with the endpoints live, consult your</p>
</div>
<div class="paragraph">
<p><a href="https://YOUR_RUNNING_ENCORE_INSTANCE/swagger-ui.html" class="bare">https://YOUR_RUNNING_ENCORE_INSTANCE/swagger-ui.html</a></p>
</div>
<div class="paragraph">
<p>for example, if you ran it on your localhost:</p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/swagger-ui.html" class="bare">http://localhost:8080/swagger-ui.html</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This is the recommended way - dynamic, powerful and
always up-to-date.
</td>
</tr>
</table>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="img/svt_encore_api.png" alt="svt encore api" width="90%">
</div>
<div class="title">Figure 1. Encore OpenAPI</div>
</div>
</div>
<div class="sect3">
<h4 id="statically-generated-endpoint-documentation">Statically generated Endpoint documentation</h4>
<div class="paragraph">
<p>To see a static version, refer to the <a href="openapi.html">Static Endpoints</a> documentation.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The statically generated documentation needs to be cleaned up, as it is autogenerated, with quite a few quirks.
This will happen when the project is mature.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="models">Models</h3>
<div class="sect3">
<h4 id="encore-job-2">Encore Job</h4>
<div class="paragraph">
<p>The Encore Job is a central object in Encore.
The Encore Job fields are described in the <a href="#dynamically-generated-endpoint-documentation">[dynamically-generated-endpoint-documentation]</a>, but also in the</p>
</div>
<div class="paragraph">
<p><a href="openapi.html#_encorejob">EncoreJob static documentation</a></p>
</div>
<details>
<summary class="title">The Encore Job class in Kotlin (click to expand)</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="kotlin" class="language-kotlin hljs">  // SPDX-FileCopyrightText: 2020 Sveriges Television AB
  //
  // SPDX-License-Identifier: EUPL-1.2

  package se.svt.oss.encore.model

  import com.fasterxml.jackson.annotation.JsonIgnore
  import io.swagger.v3.oas.annotations.media.Schema
  import io.swagger.v3.oas.annotations.tags.Tag
  import org.springframework.data.annotation.Id
  import org.springframework.data.redis.core.RedisHash
  import org.springframework.data.redis.core.index.Indexed
  import org.springframework.validation.annotation.Validated
  import se.svt.oss.encore.model.input.Input
  import se.svt.oss.mediaanalyzer.file.MediaFile
  import java.net.URI
  import java.time.OffsetDateTime
  import java.util.UUID
  import javax.validation.constraints.Max
  import javax.validation.constraints.Min
  import javax.validation.constraints.NotBlank
  import javax.validation.constraints.NotEmpty
  import javax.validation.constraints.Positive

  @Validated
  @RedisHash("encore-jobs", timeToLive = (60 * 60 * 24 * 7).toLong()) // 1 week ttl
  @Tag(name = "encorejob")
  data class EncoreJob(

      @Schema(
          description = "The Encore Internal EncoreJob Identity", example = "fb2baa17-8972-451b-bb1e-1bc773283476",
          accessMode = Schema.AccessMode.READ_ONLY, hidden = false, defaultValue = "A random UUID"
      )
      @Id val id: UUID = UUID.randomUUID(),

      @Schema(
          description = "External id - for external backreference", example = "any-string",
          nullable = true
      )
      val externalId: String? = null,

      @Schema(
          description = "The name of the encoding profile to use",
          example = "x264-animated", required = true
      )
      @NotBlank
      val profile: String,

      @Schema(
          description = "A directory path to where the output should be written",
          example = "/an/output/path/dir", required = true
      )
      @NotBlank
      val outputFolder: String,

      @Schema(
          description = "Base filename of output files",
          example = "any_file", required = true
      )
      @NotBlank
      val baseName: String,

      @Schema(
          description = "The Creation date for the EncoreJob",
          example = "2021-04-22T03:00:48.759168+02:00", accessMode = Schema.AccessMode.READ_ONLY,
          defaultValue = "now()"
      )
      @Indexed
      val createdDate: OffsetDateTime = OffsetDateTime.now(),

      @Schema(
          description = "An url to which the progress status callback should be directed",
          example = "http://projectx/encorecallback", nullable = true
      )
      val progressCallbackUri: URI? = null,

      @Schema(
          description = "The queue priority of the EncoreJob",
          defaultValue = "0", minimum = "0", maximum = "100"
      )
      @Min(0)
      @Max(100)
      val priority: Int = 0,

      @Schema(
          description = "The exception message, if the EncoreJob failed",
          example = "input/output error", accessMode = Schema.AccessMode.READ_ONLY, nullable = true
      )
      var message: String? = null,

      @Schema(
          description = "The EncoreJob progress",
          example = "57", accessMode = Schema.AccessMode.READ_ONLY, defaultValue = "0"
      )
      var progress: Int = 0,

      @Schema(
          description = "The Encoding speed of the job (compared to it's play speed/input duration)",
          example = "0.334", accessMode = Schema.AccessMode.READ_ONLY, nullable = true
      )
      var speed: Double? = null,

      @Schema(
          description = "The time for when the EncoreJob was picked from the queue)",
          example = "2021-04-19T07:20:43.819141+02:00", accessMode = Schema.AccessMode.READ_ONLY, nullable = true
      )
      var startedDate: OffsetDateTime? = null,

      @Schema(
          description = "The time for when the EncoreJob was completed (fail or success)",
          example = "2021-04-19T07:20:43.819141+02:00", accessMode = Schema.AccessMode.READ_ONLY, nullable = true
      )
      var completedDate: OffsetDateTime? = null,

      @Schema(
          description = "Instruct Encore to overlay encoding metadata on the encoded video stream",
          defaultValue = "false"
      )
      val debugOverlay: Boolean = false,

      @Schema(
          description = "Key/Values to append to the MDC log context", defaultValue = "{}"
      )
      val logContext: Map&lt;String, String&gt; = emptyMap(),

      @Schema(description = "Seek to given time in seconds before encoding output.", nullable = true, example = "60.0")
      val seekTo: Double? = null,

      @Schema(description = "Limit output to given duration.", nullable = true, example = "60.0")
      val duration: Double? = null,

      @Schema(
          description = "Time in seconds for when the thumbnail should be picked. Overrides profile configuration for thumbnails",
          example = "1800.5", nullable = true
      )
      @Positive
      val thumbnailTime: Double? = null,

      @NotEmpty
      val inputs: List&lt;Input&gt; = emptyList()
  ) {

      @Schema(
          description = "Analyzed models of the output files",
          accessMode = Schema.AccessMode.READ_ONLY
      )
      var output = emptyList&lt;MediaFile&gt;()

      @Schema(
          description = "The Job Status",
          accessMode = Schema.AccessMode.READ_ONLY
      )

      @Indexed
      var status = Status.NEW
          set(value) {
              field = value
              if (value.isCompleted) {
                  completedDate = OffsetDateTime.now()
              }
              if (value == Status.IN_PROGRESS) {
                  startedDate = OffsetDateTime.now()
              }
          }

      val contextMap: Map&lt;String, String&gt;
          @JsonIgnore
          get() = mapOf(
              "id" to id.toString(),
              "file" to baseName,
              "externalId" to (externalId ?: ""),
              "profile" to profile
          ) + logContext
  }</code></pre>
</div>
</div>
</div>
</details>
<div class="imageblock text-center">
<div class="content">
<img src="img/svt_encore_job_processing.png" alt="svt encore job processing" width="90%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="profile-2">Profile</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
See the <a href="#profiles">Profiles</a> section in the Appendix for concrete <a href="#profile">Profile</a> examples.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <strong>Profile</strong> consists of toplevel metadata, and a list of encoding configuration types - <em>encodes</em>.</p>
</div>
<table class="tableblock frame-sides grid-none stripes-even stretch">
<caption class="title">Table 1. Profile metadata</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Constraint</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">profile name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a helpful description of the profile</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">scaling</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">directly matching the FFmpeg scaling algorithm options</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">if given, one of the <a href="https://ffmpeg.org/ffmpeg-scaler.html">FFmpeg Scaling algorithm options</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lanczos</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">encodes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a list of encode types (configurations) for the profile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#audioencode">AudioEncode</a>
<a href="#videoencode">X264Encode</a>
<a href="#videoencode">X265Encode</a>
<a href="#thumbnailencode">ThumbnailEncode</a>
<a href="#thumbnailmapencode">ThumbnailMapEncode</a></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="profile-encode-types">Profile Encode Types</h4>
<div class="sect4">
<h5 id="audio">Audio</h5>
<div class="paragraph">
<p>The <a href="#audioencode">AudioEncode</a> type is, as the name implies, for audio encoding.</p>
</div>
<div class="paragraph">
<p>The AudioEncode type can exist at two levels in a Profile configuration:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>As a field, audioEncode, in <em>encodes:</em> <a href="#videoencode">VideoEncode</a> - the audio stream will be embedded in the output video container.</p>
</li>
<li>
<p>As a separate Encode type in the <em>encodes</em> list - the audio stream will be written to a separate output filestream.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>TODO: Describe the new mapping logic</p>
</div>
<hr>
<table id="audioencode" class="tableblock frame-sides grid-none stripes-even stretch">
<caption class="title">Table 2. AudioEncode</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Constraint</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">codec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://ffmpeg.org/ffmpeg-codecs.html#Audio-Decoders">FFmpeg audio codec library</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://wiki.hydrogenaud.io/index.php?title=Fraunhofer_FDK_AAC">libfdk_aac</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bitrate</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">optional</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">samplerate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The audio sample rate in hz</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">48000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">channels</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number of channels</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">suffix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">suffix for the audio output file</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{codec]_{nrofchannels}.ch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">params</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map of FFmpeg parameters to the given codec - cutoff etc</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">filters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">any optional filters to FFmpeg.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">audioMixPreset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the name of the default <a href="#audiomixpreset">AudioMixPreset</a> to use, if any</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"default"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">skipIfNoAudioMixPreset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">don&#8217;t encode audio if no mix was found</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">output file extension</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mp4</p></td>
</tr>
</tbody>
</table>
<hr>
</div>
<div class="sect4">
<h5 id="video">Video</h5>
<div class="paragraph">
<p>The <a href="#videoencode">VideoEncode</a> type is, as the name implies, for video encoding.</p>
</div>
<div class="paragraph">
<p>VideoEncode is a base type, for building concrete (n)Encode type implementations on. Existing examples are <a href="#x264encode">X264Encode</a> and <a href="#x265encode">X265Encode</a>.
It is not intended for direct usage.</p>
</div>
<table id="videoencode" class="tableblock frame-sides grid-none stripes-even stretch">
<caption class="title">Table 3. VideoEncode</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Constraint</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">width</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">adds the <a href="https://ffmpeg.org/ffmpeg-filters.html#scale">scale filter</a> (if scaling enabled)</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null, or -2 if only height is given</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">height</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">adds the <a href="https://ffmpeg.org/ffmpeg-filters.html#scale">scale filter</a> (if scaling enabled)</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null, or -2 if only height is given</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">twoPass</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true, false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If FFmpeg transcoding should be <a href="https://en.wikipedia.org/wiki/Variable_bitrate#Multi-pass_encoding_and_single-pass_encoding">twoPass</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">params</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">general FFmpeg Encoding parameters (see <a href="#profiles">examples</a>, vsync etc)</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">filters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">for adding extra <a href="https://ffmpeg.org/ffmpeg-filters.html">FFmpeg Filters</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">audioEncode</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#audioencode">AudioEncode</a> or null</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">suffix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">suffix added to the output filename</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The file output format</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">codec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">codec library to use</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">example: libx264</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <a href="#x264encode">X264Encode</a> will encode to AVC (H.264) video using <a href="https://www.videolan.org/developers/x264.html">libx264</a>.</p>
</div>
<table id="x264encode" class="tableblock frame-sides grid-none stripes-even stretch">
<caption class="title">Table 4. X264Encode</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Constraint</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">fields from  <a href="#videoencode">VideoEncode</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x264-params</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map of specific x264 codec library parameters</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">deblock, keyint, etc, see <a href="https://trac.ffmpeg.org/wiki/Encode/H.264">Overwriting default preset settings - FFmpeg x264</a>
and  <a href="#profiles">Profiles</a> for examples</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mp4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">codec</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://trac.ffmpeg.org/wiki/Encode/H.264">"libx264"</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <a href="#x265encode">X265Encode</a> will encode to HEVC (H.265) video using <a href="https://www.videolan.org/developers/x265.html">libx265</a>.</p>
</div>
<table id="x265encode" class="tableblock frame-sides grid-none stripes-even stretch">
<caption class="title">Table 5. X265Encode</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Constraint</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">fields from  <a href="#videoencode">VideoEncode</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x265-params</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map of specific x265 codec library parameters</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">deblock, scenecut, etc, see <a href="https://trac.ffmpeg.org/wiki/Encode/H.265">Passing Options for FFmpeg x265</a>
  and  <a href="#profiles">Profiles</a> for examples</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mp4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">codec</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://trac.ffmpeg.org/wiki/Encode/H.265">"libx265"</a></p></td>
</tr>
</tbody>
</table>
<hr>
</div>
<div class="sect4">
<h5 id="image">Image</h5>
<div class="paragraph">
<p><a href="#thumbnailmapencode">ThumbnailMapEncode</a> generates a thumbnailmap from the input video.</p>
</div>
<table id="thumbnailmapencode" class="tableblock frame-sides grid-none stripes-even stretch">
<caption class="title">Table 6. ThumbnailMapEncode</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Constraint</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aspectWidth</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aspectHeight</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tileHeight</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">90</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cols</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rows</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#thumbnailencode">ThumbnailEncode</a> generates an image/images from the video.
The extraction point/points are given as either a specific time, or, a list of percentages.</p>
</div>
<table id="thumbnailencode" class="tableblock frame-sides grid-none stripes-even stretch">
<caption class="title">Table 7. ThumbnailEncode</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Constraint</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">percentages</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[25, 50, 75]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">thumbnailWidth</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">thumbnailHeight</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1080</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">thumbnailTime</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1080</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-community-guide">The Community Guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>General community information like the F.A.Q and links to Encore mentions.</p>
</div>
<div class="sect2">
<h3 id="faq">Frequently Asked Questions</h3>
<div class="sect3">
<h4 id="how-can-i-package-my-transcoded-media-for-online-streaming-dash-and-hls">How can I package my transcoded media for online streaming (DASH and HLS)?</h4>
<div class="paragraph">
<p>You could have a look at <a href="https://google.github.io/shaka-packager/html/">Shaka Packager</a>, <a href="https://github.com/axiomatic-systems/Bento4">Bento4</a>, and configure them to process the output of <strong>Encore</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="how-can-i-generate-my-own-openapi-documentation-for-import-into-x">How can I generate my own OpenAPI documentation, for import into X</h4>
<div class="paragraph">
<p>To create your own OpenAPI-export from <strong>Encore</strong> so that you can transform it as you wish:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">  $ SPRING_PROFILES_ACTIVE=local ./gradlew clean generateOpenApiDocs</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will give you a <em>build/openapi.json</em> file for further processing.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For further information on how you can configure the API-generation, see the <a href="https://springdoc.org/">Springdoc Project</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="i-have-great-ideabugfiximprovement-to-encore-how-do-i-submit-it">I have great idea/bugfix/improvement to Encore, how do I submit it?</h4>
<div class="paragraph">
<p>See <a href="#contributorguide">The Contribute section</a></p>
</div>
</div>
<div class="sect3">
<h4 id="can-i-write-a-pluginextension-for-doing-x-in-encore">Can I write a plugin/extension for doing X in <strong>Encore</strong>?</h4>
<div class="paragraph">
<p>Currently, there are no extensions interface endpoints, but you could, for example, add transcoding functionality by writing an FFMpeg filter - some examples of how that can done can be found at <a href="https://github.com/SVT/ffmpeg-filter-proxy-filters">FFmpeg proxy filters</a> - have a peek at the <a href="https://github.com/svt/homebrew-avtools">Homebrew AVTools</a> for how to build an FFmpeg with them.</p>
</div>
<div class="paragraph">
<p>Also, open a discussion issue if you have any ideas regarding contributions about extensions to <strong>Encore</strong> that you want to discuss.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="articles-and-talks">Articles and talks</h3>
<div class="paragraph">
<p><a href="https://medium.com/the-svt-tech-blog/encore-open-source-licensed-to-once-again-transcode-bbf854f7a812">Article: 2021 - Encore - licensed to once again transcode</a>
- an article about how, and why, we released <strong>Encore</strong> as Open Source and an introduction to how it basically works.</p>
</div>
<div class="paragraph">
<p><a href="https://conf.tube/videos/watch/751d41f4-72fd-4bfe-aa26-8d8b0e8054c2">Video: 2019 - FOSS made us do it</a>
- How <strong>Encore</strong> and FOSS tools enables the Video Encoding at SVT</p>
</div>
<div class="paragraph">
<p><a href="https://medium.com/the-svt-tech-blog/encore-video-transcoding-at-its-core-b80c3e5658b3">Article: 2018 Encore - video transcoding at it&#8217;s core</a>
- while interesting for the project origins, it contains partially <strong>non-valid information</strong> as the code has been largely rewritten since then.</p>
</div>
</div>
<div class="sect2">
<h3 id="support">Support</h3>
<div class="paragraph">
<p>There is <strong>no formal</strong> support - none, nada, nothing - for <strong>Encore</strong> directly from the main contributors / maintainers - but we <strong>would love if</strong> people use and improve the project, so here are some suggestions if you are stuck.</p>
</div>
<div class="paragraph">
<p><strong>File an Issue on GitHub</strong></p>
</div>
<div class="paragraph">
<p>You can always file an issue, ask a question, open a discussion issue, and we will most likely respond to that, when time allows.</p>
</div>
<div class="paragraph">
<p><strong>Stack Overflow</strong></p>
</div>
<div class="paragraph">
<p>If your question does not contain sensitive information, please ask a question on <a href="https://stackoverflow.com/">Stack Overflow</a> and use the tag 'svtencore'. Maybe some other users will help you.</p>
</div>
</div>
<div class="sect2">
<h3 id="projecthistory">Project History</h3>
<div class="paragraph">
<p><strong><em>The initiative</em></strong></p>
</div>
<div class="paragraph">
<p>It was around 2018, and it was time to yet again update the license and the hardware for our proprietary non-flexible transcoding solution.
Although that unnamed solution had served us very well, we also had a history of less than optimal transcoding, flexibility and support when things went wrong.
Around that period, it happened that, our organisation was preparing the next "Tekniksprint".
A "Tekniksprint" is an "innovate for an entire sprint" period, which happens two times a year at our organisation.
That time, a small team gathered, with the purpose of seeing how much of a video transcoding solution that could be built in two weeks.
So, with warts, hacks and shortcuts, we had a fun Sprint period, and also ended up with something <a href="#articles-and-talks">almost usable, see links</a>.
And, yes, it even had GUI, so that we could make it pretty demo friendly.
However, it was not very robust, and something we could build further upon.</p>
</div>
<div class="paragraph">
<p>By having a Proof-of-Concept project, we now could now walk the long and winding internal organisation road of convincing everyone that we could, and that we should re-write the project seriously - considering flexibility, features and support in comparison with others.</p>
</div>
<div class="paragraph">
<p><strong><em>The development</em></strong></p>
</div>
<div class="paragraph">
<p>It almost became a meme for us, but in 2019 we wrote ut, tested it, and ran it in production, with so good results, that we could ditch out proprietary solution.
In fact, <strong>Encore</strong> helped us achieve better quality, better flexibility, and saved us money - the costs for developing the Encore solution was multitudes less than buying just another new stack.</p>
</div>
<div class="paragraph">
<p>We now had an easier way to work with new codecs and transcoding features that would be impossible, had we chosen another proprietary solution.</p>
</div>
<div class="paragraph">
<p><strong><em>The Open Source Encore</em></strong></p>
</div>
<div class="paragraph">
<p>We always had the intention to Open Source the solution, as we heard that others, mainly friends in Public Broadcast organisations, had an interest in the product.
So during 2019/20 , with almost every Sprint-period, we tried to have at least a task that was directly prepared with Open Sourcing Encore.
Slowly, but determined.</p>
</div>
<div class="paragraph">
<p>From license research, documentation, basic code cleanups, removing the most SVT-specific code, and releasing libraries that would make it possible to release the project itself.
Warts and all, finally we got there.</p>
</div>
<div class="paragraph">
<p>So far, Encore has been a success story for us at SVT.
We sincerely hope that it can benefit you, and with time grow to be an even greater transcoding solution.</p>
</div>
<div class="paragraph">
<p>/<em>The Videocore Team at SVT</em></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="contributorguide">The Contributor Guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We gratefully accept contributions via <a href="https://help.github.com/articles/about-pull-requests/">pull requests</a>.</p>
</div>
<div class="paragraph">
<p>Use the issue tracker to suggest feature requests, report bugs, and ask questions.
This is also a great way to connect with the developers of the project as well as others who are interested in this solution.</p>
</div>
<div class="sect2">
<h3 id="changing-the-code-base">Changing the code-base</h3>
<div class="paragraph">
<p>Generally speaking, you should fork this repository, make changes in your
own fork, and then submit a pull-request.
This is often called the <a href="https://gist.github.com/Chaser324/ce0505fbed06b947d962">Fork-and-Pull model</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p>All contributions to this project will be released under the inbound=outbound norm, that is,
they are submitted under the projects main license.</p>
</li>
<li>
<p>By submitting a pull request or filing a bug, issue, or
feature request, you agree to comply with this waiver of copyright interest.
Details can be found in the <a href="https://joinup.ec.europa.eu/collection/eupl/eupl-text-eupl-12">EUPL 1.2 or later</a>.</p>
</li>
<li>
<p>All new code should have associated unit
tests that validate implemented features and the presence or lack of defects.</p>
</li>
<li>
<p>Additionally, the code should follow any stylistic and architectural guidelines
prescribed by the project. In the absence of such guidelines, mimic the styles
and patterns in the existing code-base.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="sign-off-and-optionally-sign-each-commit">Sign-off and optionally Sign each Commit</h3>
<div class="paragraph">
<p>As part of filing a pull request you agree to the DCO, <a href="https://developercertificate.org/">Developer Certificate of Origin</a></p>
</div>
<div class="paragraph">
<p>A DCO is a lightweight way for a contributor to confirm that they wrote or otherwise have the right to submit code or documentation to a project.</p>
</div>
<div class="paragraph">
<p>To confirm that you agree to the DCO, you need to <strong>sign off</strong> your commits when sending us a pull request.
Technically, this is done by supplying the <code>-s</code>/<code>--signoff</code> flag to git when committing:</p>
</div>
<div class="paragraph">
<p><code>$ git commit -s -m "add fix for the bug"</code></p>
</div>
<div class="paragraph">
<p>Optionally, you can also sign the commit with <code>-S</code> which also gives your commit a nice verified button on GitHub,
but, it requires that you have a GPG keypair set up.</p>
</div>
<div class="paragraph">
<p>For mor information, see <a href="https://docs.github.com/en/github/authenticating-to-github/signing-commits">Sign commit on GitHub with GPG key</a></p>
</div>
<div class="paragraph">
<p><code>$ git commit -s -S -m "add fix for the bug"</code></p>
</div>
<div class="paragraph">
<p>For the difference in signoff and signing, see
<a href="https://medium.com/@MarkEmeis/git-commit-signoff-vs-signing-9f37ee272b14/">Git signoff vs signing</a></p>
</div>
</div>
<div class="sect2">
<h3 id="git-history">Git History</h3>
<div class="paragraph">
<p>In order to maintain a high software quality standard, contributions should aim to follow these rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We pay more attention to the quality of commit messages.
In general, we share the view on how commit messages should be written with
<a href="https://github.com/git/git/blob/master/Documentation/SubmittingPatches">the Git project itself</a>:</p>
</li>
<li>
<p><a href="https://github.com/git/git/blob/e6932248fcb41fb94a0be484050881e03c7eb298/Documentation/SubmittingPatches#L43">Make separate commits for logically separate changes.</a>
For example, pure formatting changes that do not affect software behaviour usually do not belong in the same commit as changes to program logic.</p>
</li>
<li>
<p><a href="https://github.com/git/git/blob/e6932248fcb41fb94a0be484050881e03c7eb298/Documentation/SubmittingPatches#L101">Describe your changes well.</a>
Do not just repeat in prose what is "obvious" from the code, but provide a rationale explaining <em>why</em> you believe your change is necessary.</p>
</li>
<li>
<p><a href="https://github.com/git/git/blob/e6932248fcb41fb94a0be484050881e03c7eb298/Documentation/SubmittingPatches#L133">Describe your changes in the imperative.</a>
Instead of writing "Fixes an issue with transcoding" prefer "Fix an transcoding issue". Think about it like the commit only does something <em>if</em> it is applied.
This usually results in more concise commit messages.</p>
</li>
<li>
<p><a href="https://github.com/git/git/blob/e6932248fcb41fb94a0be484050881e03c7eb298/Documentation/SubmittingPatches#L95">We are picky about whitespaces.</a>
Trailing whitespace and duplicate blank lines are simply a superfluous annoyance, and most Git tools flag them red in the diff anyway.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Have a look at basically any of <a href="https://github.com/git/git/commits?author=peff">Jeff King&#8217;s commits</a> in the Git project.</p>
</div>
<div class="paragraph">
<p>Thank you for reading and happy contributing!</p>
</div>
<div class="paragraph">
<p><em>There are no more guides.
You are now on your own.
Thank you!.</em></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix">Appendix</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="application-properties">Application Properties</h3>
<div class="paragraph">
<p>Beside the rich configuration possibilities of <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/appendix-application-properties.html">Spring Boot and friends</a>, a few custom properties can be specified inside your application.properties file, inside your application.yml file, or as command line switches.</p>
</div>
<table id="customapplicationproperties" class="tableblock frame-sides grid-none stripes-even stretch">
<caption class="title">Table 8. Custom Application Properties - <strong>prefix: encore-settings</strong></caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local-temporary-encode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">if true, encoding is done in a temporary folder on the Encore instance currently running the job. When done, the results are moved to the where the Encore Job&#8217;s output folder path is pointing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">audio-mix-presets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a default <a href="#audiomixpreset">AudioMixPreset</a> is created</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a list of <a href="#audiomixpreset">AudioMixPreset</a>s to use</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">concurrency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max nr of currently running encoding tasks (property starts at 0, so 0 gives 1 task).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">poll-initial-delay</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">initial wait time in seconds before task starts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">poll-delay</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">wait before polling, in seconds, for next task after compilation of the current task.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">redis-key-prefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encore</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the prefix to identify your redis queue. Redis keys are named "$redisKeyPrefix-queue-$queueNo"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">security.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">enables basic auth, TODO: describe basic security logic</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">security.user-password</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">password for regular user</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">security.admin-password</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">password for the admin user</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">open-api.title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SVT Encore OpenAPI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">title shown in the OpenAPI url summary header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">open-api.description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Endpoints for Encore"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">description shown in the OpenAPI url summary header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">open-api.contact-name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">contact name shown in the OpenAPI gui summary header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">open-api.contact-email</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">contact email shown in the OpenAPI gui summary header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">open-api.contact-url</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">contact url shown in the OpenAPI gui summary header</p></td>
</tr>
</tbody>
</table>
<table id="audiomixpreset" class="tableblock frame-sides grid-none stripes-even stretch">
<caption class="title">Table 9. AudioMixPreset</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Constraint</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fallback-to-auto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">if true, sets the output audio channels to the number given by the <a href="#audioencode">AudioEncode</a> field channel.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the following conditions needs to apply for it to take effect:</p>
<p class="tableblock">    set to true</p>
<p class="tableblock">    nr of audio channels in input file &gt; 0</p>
<p class="tableblock"><a href="#audioencode">AudioEncode</a> channels = 2 OR between 1 and the "nr of audio channels in input file"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default-pan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">if configured, maps "autofound input audio channels" to the configured output channel configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">input file channels: configured <a href="#audioencode">AudioEncode</a> channel: the <a href="https://ffmpeg.org/ffmpeg-filters.html#pan">pan filter</a> configuration to use</p>
<p class="tableblock"> See the concrete <a href="#profiles">Profiles</a> for yaml example.</p>
<p class="tableblock"> Any configuration found in pan-mapping would take precedence over this configuration</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pan-mapping</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">if configured, maps "found input audio channels" to the configured matching output channel configurations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">input file channels: configured <a href="#audioencode">AudioEncode</a> channel: <a href="https://ffmpeg.org/ffmpeg-filters.html#pan">the pan filter</a> configuration which should be used.</p>
<p class="tableblock">  See the concrete <a href="#configurationexample">[configurationexample]</a> for yaml-examples.</p>
<p class="tableblock">  Any configuration here takes precedence over configurations in default-pan</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><em>For, clarity, here is how an encore-setting configuration with audio-mix-presets could look like in real life.</em></p>
</div>
<div class="listingblock">
<div class="title">encore-settings configuration example</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">  spring:
    jackson:
      time-zone: Europe/Stockholm

  profile:
    location: url:http://YOURPROFILESERVERURL/encore/prod/master/profiles.yml

  encore-settings:
    local-temporary-encode: true
    audio-mix-presets:
      default:
        fallback-to-auto: false
        default-pan:
          2: stereo| c0 = c0 + 0.707*c2 + 0.707*c4 | c1 = c1 + 0.707*c2 + 0.707*c5

        pan-mapping:
          6:
            2: stereo|c0=1.0*c0+0.707*c2+0.707*c4|c1=1.0*c1+0.707*c2+0.707*c5
      de:
        fallback-to-auto: false
        pan-mapping:
          6:
            2: stereo|c0&lt;0.25*c0+1.5*c2+0.25*c4|c1&lt;0.25*c1+1.5*c2+0.25*c5

  redis:
    subscription-connection-pool-size: 25
    connection-pool-size: 32
    connection-minimum-idle-size: 5
    uri: redis://YOURINSTANCE:6379
    db: 1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="homebrew-avtools">Homebrew AVTools</h3>
<div class="paragraph">
<p>So you noticed that the FFmpeg Docker Example in the quickstart used the Repository Manager Brew?
The creators of <strong>Encore</strong>, have released their Brew Formulas on <a href="https://github.com/svt/homebrew-avtools">GitHub: Homebrew AVTools</a>.</p>
</div>
<div class="paragraph">
<p>For example, here is the <strong>Encore</strong> FFmpeg Brew Formula that with minor modifications, uses formulas for X264, X265, and SVT&#8217;s subtitle filter.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To use and install this version of FFmpeg locally, follow the examples given at the <a href="https://github.com/svt/homebrew-avtools/blob/main/README.md">Homebrew AVTools README</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">The SVT <strong>Encore</strong> FFmpeg Brew Formula</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ruby" class="language-ruby hljs">  # SPDX-FileCopyrightText: 2009-present, Homebrew contributors
  # SPDX-FileCopyrightText: 2021 Sveriges Television AB
  #
  # SPDX-License-Identifier: BSD-2-Clause

  class FfmpegEncore &lt; Formula
    desc "Play, record, convert, and stream audio and video"
    homepage "https://ffmpeg.org/"
    url "https://ffmpeg.org/releases/ffmpeg-4.3.1.tar.xz"
    sha256 "ad009240d46e307b4e03a213a0f49c11b650e445b1f8be0dda2a9212b34d2ffb"
    license "GPL-2.0-only"
    revision 1
    head "https://github.com/FFmpeg/FFmpeg.git"
    option "with-ffplay", "Enable ffplay"

    depends_on "nasm" =&gt; :build
    depends_on "pkg-config" =&gt; :build
    depends_on "aom"
    depends_on "fdk-aac"
    depends_on "fontconfig"
    depends_on "freetype"
    depends_on "lame"
    depends_on "libass"
    depends_on "libsoxr"
    depends_on "libssh"
    depends_on "libvmaf"
    depends_on "libvorbis"
    depends_on "libvpx"
    depends_on "openssl"
    depends_on "x264-encore"
    depends_on "x265-encore"

    uses_from_macos "bzip2"
    uses_from_macos "zlib"

    conflicts_with "ffmpeg", because: "it also ships with ffmpeg binary"

    resource "proxy_filter" do
      url "https://github.com/SVT/ffmpeg-filter-proxy/archive/v1.0.tar.gz"
      sha256 "9a9ddfe248ea299ffa5bf9643bed95913f00b3a9d4e03f402aebc3224e4f82f3"
    end

    if build.with? "ffplay"
      depends_on "libxv" unless OS.mac?
      depends_on "sdl2"
    end

    def install
      resource("proxy_filter").stage do |stage|
        @proxyfilterpath = Dir.pwd
        stage.staging.retain!
      end
      cp_r Dir.glob("#{@proxyfilterpath}/*.c"), "libavfilter", verbose: true
      inreplace "libavfilter/allfilters.c",
                "extern AVFilter ff_vf_yadif;",
                "extern AVFilter ff_vf_yadif;\nextern AVFilter ff_vf_proxy;\n"
      inreplace "libavfilter/Makefile",
                "# video filters",
                "# video filters\nOBJS-\$(CONFIG_PROXY_FILTER) += vf_proxy.o\n"

      args = %W[
        --prefix=#{prefix}
        --enable-shared
        --enable-pthreads
        --enable-version3
        --enable-hardcoded-tables
        --enable-avresample
        --cc=#{ENV.cc}
        --host-cflags=#{ENV.cflags}
        --host-ldflags=#{ENV.ldflags}
        --enable-gpl
        --enable-libaom
        --enable-libmp3lame
        --enable-libvorbis
        --enable-libvpx
        --enable-libx264
        --enable-libx265
        --enable-lzma
        --enable-libass
        --enable-libfontconfig
        --enable-libfreetype
        --disable-libjack
        --disable-indev=jack
        --enable-libaom
        --enable-openssl
        --enable-libssh
        --enable-libfdk-aac
        --enable-libvmaf
        --enable-nonfree
      ]
      args &lt;&lt; "--enable-ffplay" if build.with? "ffplay"
      args &lt;&lt; "--enable-videotoolbox" if OS.mac?
      system "./configure", *args
      system "make", "install"

      # Build and install additional FFmpeg tools
      system "make", "alltools"
      bin.install Dir["tools/*"].select { |f| File.executable? f }

      # Fix for Non-executables that were installed to bin/
      mv bin/"python", pkgshare/"python", force: true
    end

    test do
      # Create an example mp4 file
      mp4out = testpath/"video.mp4"
      system bin/"ffmpeg", "-filter_complex", "testsrc=rate=1:duration=1", mp4out
      assert_predicate mp4out, :exist?
    end
  end</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
If you use Homebrew-AVTools, the version of FFmpeg in use might be updated without <strong>any</strong> notice.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="profiles">Profiles</h3>
<div class="listingblock">
<div class="title">Profile example, main</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">  program: withforcekeyframe.yml
  youtube: video.yml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Profile example, x264 codec with forced keyframes</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">  name: program
  description: Program profile
  scaling: bicubic
  encodes:
    - type: X264Encode
      suffix: 3100
      twoPass: true
      height: 1080
      params:
        b:v: 3100k
        maxrate: 4700k
        bufsize: 6200k
        r: 25
        vsync: 1
        pix_fmt: yuv420p
        force_key_frames: expr:not(mod(n,96))
        profile:v: high
        level: 4.1
      x264-params:
        deblock: 0,0
        aq-mode: 1
        bframes: 6
        keyint: 192
        keyint_min: 96
        ref: 4
      audioEncode:
        type: AudioEncode
        bitrate: 192k
        suffix: STEREO
    - type: X264Encode
      suffix: 2069
      twoPass: true
      height: 720
      params:
        b:v: 2069k
        maxrate: 3104k
        bufsize: 4138k
        r: 25
        vsync: 1
        pix_fmt: yuv420p
        force_key_frames: expr:not(mod(n,96))
        profile:v: main
        level: 3.1
      x264-params:
        deblock: 0,0
        aq-mode: 1
        bframes: 6
        keyint: 192
        keyint_min: 96
        ref: 4
      audioEncode:
        type: AudioEncode
        bitrate: 128k
        suffix: STEREO
    - type: X264Encode
      suffix: 1312
      twoPass: true
      height: 540
      params:
        b:v: 1312k
        maxrate: 1968k
        bufsize: 2524k
        r: 25
        vsync: 1
        pix_fmt: yuv420p
        force_key_frames: expr:not(mod(n,96))
        level: 3.1
        profile:v: main
      x264-params:
        deblock: 0,0
        aq-mode: 1
        bframes: 6
        keyint: 192
        keyint_min: 96
        ref: 4
      audioEncode:
        type: AudioEncode
        bitrate: 96k
        suffix: STEREO
    - type: X264Encode
      suffix: 806
      twoPass: true
      height: 360
      params:
        b:v: 806121
        maxrate: 1209182
        bufsize: 1612242
        r: 25
        vsync: 1
        pix_fmt: yuv420p
        force_key_frames: expr:not(mod(n,96))
        profile:v: main
        level: 3.1
      x264-params:
        deblock: 0,0
        aq-mode: 1
        bframes: 6
        keyint: 192
        keyint_min: 96
        ref: 4
      audioEncode:
        type: AudioEncode
        bitrate: 96k
        suffix: STEREO
    - type: X264Encode
      suffix: 320
      twoPass: true
      height: 234
      params:
        b:v: 324051
        maxrate: 486077
        bufsize: 648102
        r: 25
        vsync: 1
        pix_fmt: yuv420p
        force_key_frames: expr:not(mod(n,96))
        profile:v: baseline
        level: 3.1
      x264-params:
        deblock: 0,0
        aq-mode: 1
        keyint: 192
        keyint_min: 96
        ref: 3
      audioEncode:
        type: AudioEncode
        bitrate: 96k
        suffix: STEREO
    - type: AudioEncode
      bitrate: 192k
      suffix: STEREO
      params:
        cutoff: 20000
    - type: AudioEncode
      bitrate: 64k
      suffix: STEREO_LB
      params:
        cutoff: 14000
    - type: AudioEncode
      bitrate: 192k
      suffix: STEREO_DE
      audioMixPreset: de
      skipIfNoAudioMixPreset: true
      params:
        cutoff: 20000
    - type: AudioEncode
      bitrate: 64k
      suffix: STEREO_DELB
      audioMixPreset: de
      skipIfNoAudioMixPreset: true
      params:
        cutoff: 14000
    - type: AudioEncode
      codec: ac3
      bitrate: 448k
      suffix: SURROUND
      channels: 6
    - type: ThumbnailMapEncode
    - type: ThumbnailEncode (edited)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Profile example, x264 codec</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">  name: youtube
  description: Youtube upload
  encodes:
    - type: X264Encode
      suffix: 10000
      twoPass: false
      height: 1080
      params:
        crf: 15
        r: 25
        vsync: 1
        pix_fmt: yuv420p
        profile:v: high
        level: 5.1
      x264-params:
        vbv-maxrate: 10000
        vbv-bufsize: 20000
        deblock: 0,0
        aq-mode: 1
        bframes: 4
        keyint: 202
        keyint_min: 100
        ref: 8
      audioEncode:
        type: AudioEncode
        bitrate: 256k
        suffix: STEREO</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the-future">The Future</h3>
<div class="paragraph">
<p>We have a few ideas where we would like to go with Encore.
We are focusing on the features we need, but we are always open to suggestion and discussion, if you would like to contribute to the project.</p>
</div>
</div>
<div class="sect2">
<h3 id="asciidoc-debug">Asciidoc Debug</h3>
<div class="dlist">
<div class="title">Built-in</div>
<dl>
<dt class="hdlist1">asciidoctor-version</dt>
<dd>
<p>2.0.10</p>
</dd>
<dt class="hdlist1">safe-mode-name</dt>
<dd>
<p>unsafe</p>
</dd>
<dt class="hdlist1">docdir</dt>
<dd>
<p>/home/runner/work/encore-doc/encore-doc/src/docs/asciidoc</p>
</dd>
<dt class="hdlist1">docfile</dt>
<dd>
<p>/home/runner/work/encore-doc/encore-doc/src/docs/asciidoc/encore-documentation.adoc</p>
</dd>
<dt class="hdlist1">imagesdir</dt>
<dd>
<p>{imagesdir}</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Encoding = source file is uncompressed, Transcoding = source file is compressed. The distinction might not matter much in practice, but we prefer to use the term Transcoding in the Encore documentation
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. In reality the Encore Job itself is not offered to, or polled from the queue - it is an Object QueueItem, which holds the needed metadata for the Encore Job
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.1<br>
Last updated 2021-10-08 19:14:10 UTC
</div>
</div>
<link rel="stylesheet" href="js/highlight/styles/darcula.min.css">
<script src="js/highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>